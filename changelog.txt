# Changelog

## January 19, 2026

### Fixed
- **Misleading quota message for free users**: Fixed bug where free users hitting their quota saw "Monthly limit reached - resets next month" instead of "Scan limit reached - Upgrade to Pro". The monthly reset message was misleading because free users have a lifetime limit that never resets. Now checks lifetime limit first before monthly limit.
- **CRITICAL: Quota not consumed on cache hits**: Fixed bug where cached scan results bypassed quota consumption entirely, allowing unlimited free scans. Now properly consumes quota via RPC even when returning cached analysis results.
- **Scan flow instability**: Analysis state now properly resets when scanning a new item (was showing stale results from previous scans when screen was reused)
- **Wardrobe updates not reflected**: Results screen now refreshes wardrobe data when returning from add-item (matches now update immediately after adding wardrobe items)
- **Scan camera processing overlay issues**: Fixed "Checking scan access..." overlay appearing incorrectly when returning to scan screen from results, and eliminated flash of previous camera screen when tapping "Scan another item"

### Security
- Moved OpenAI API key to server-side Edge Function (no longer exposed in client bundle)
- Added server-side rate limiting to prevent abuse (50 requests/user/hour, 100 requests/minute globally)

### Added
- **Monthly quota limits** for all users (including Pro) to prevent runaway API costs
  - Free: 5 scans/month, 15 wardrobe adds/month
  - Pro: 500 scans/month, 1000 wardrobe adds/month
- Server-side quota enforcement via Supabase Edge Function
- Idempotency keys to prevent double-charging on retries
- Auto-retry when app returns from background during analysis
- Credit consumption details added to Help Center (explains when credits are used)

### Fixed
- **Storage upload RLS errors**: Added session verification before background uploads to prevent "row-level security policy" errors when session expires or app restarts before auth is restored
- Wardrobe adds now consume from correct quota pool (was incorrectly using scan credits)
- Dark overlay on logout/transition screens now covers full screen edge-to-edge
- Analysis failures when app goes to background now auto-retry on return
- **Add wardrobe item background recovery**: Fixed bug where adding a wardrobe item while app goes to background would fail to manual form instead of auto-retrying. Now stays in loading state (up to 2 retries) for seamless recovery when returning from background.
- **Scan item background flash eliminated**: Fixed brief flash of "Couldn't analyze" error screen when returning from background during scan analysis. Now stays in loading state for seamless retry (up to 3 attempts).
- Paywall no longer interrupts users who used their last credit successfully (was showing paywall after analysis completed)
- **Scan flow now shows paywall BEFORE capture** when quota exceeded (previously let users scan then blocked them after)
- Scan paywall now shows correct title "You've used your 5 free scans" (was showing wrong paywall type)

### Improved
- **Add wardrobe item performance**: Removed redundant client-side quota check (~100-200ms faster)
- Skip cache lookup for wardrobe adds (user photos are unlikely to be cached, saves ~189ms on misses)
- Image picker no longer forces cropping (iOS limitation prevented free-form crop, now uses full image)
- AI now generates richer style notes (2 descriptive sentences instead of short phrases)

### Technical
- New Edge Function: `analyze-image` handles auth, quota, rate limits, and OpenAI calls
- Database migration: `006_monthly_quotas.sql` adds monthly tracking columns and functions
- `analyzeClothingImage` now accepts `operationType` ('scan' | 'wardrobe_add') and `skipCache` params
- Changes made by agent 2026-01-19T21:07:32Z
- Changes made by agent 2026-01-19T21:12:53Z
