# Changelog

## January 21, 2026

### Improved
- **Camera permission UX**: Added pre-prompt screen before iOS system permission dialog to improve grant rates and comply with App Store Review Guidelines. Users now see a custom explanation screen before the native dialog, with clear messaging about why camera access is needed.
- **Camera permission handling**: Implemented robust permission state machine with explicit refresh logic when returning from Settings. Permission status is now the single source of truth, with UI-driven screen states and retry backoff (150ms → 300ms → 500ms) for reliable detection of permission changes.
- **Restricted camera access handling**: Added proper support for iOS "restricted" status (parental controls/MDM) with appropriate messaging that doesn't mislead users to open Settings when it won't help.

### Fixed
- **Post-denial Settings navigation**: Fixed issue where post-denial screen appeared when user returned from Settings after granting camera permission. Now only refreshes permission state when user explicitly taps "Open Settings", preventing unnecessary retries during random app backgrounding (Control Center, multitasking).
- **Paywall purchase button reliability**: Fixed critical issue where purchase button remained tappable even when RevenueCat packages failed to load, causing silent failures. Button now properly disables when packages unavailable, shows "Unavailable" or "Loading..." states, and displays user-friendly error alerts with retry option. Removes misleading fallback prices that could trigger App Review rejection.
- **Subscription purchase error handling**: Enhanced purchase flow with proper error handling for user cancellations (no error shown), entitlement polling (waits up to 10 seconds for activation), and detailed error messages. Added unavailable banner with retry button when offerings fail to load.
- **RevenueCat offerings retry mechanism**: Fixed React Query retry to properly trigger on failures by throwing errors instead of returning null. Query now auto-retries twice with 1s delay, handles error states explicitly, and shows appropriate UI feedback during all states (loading, error, success).

## January 20, 2026

### Fixed
- **Password reset flow**: Fixed navigation loop causing landing page to blink when user tapped reset password link from email. AuthGuard now properly allows reset-password-confirm screen without redirecting. Added comprehensive error handling with proper validation states (link expired, invalid session) and user-friendly error messages aligned with app-wide design patterns.
- **Password reset double-screen and link expired bug**: Fixed issue where clicking password reset link from email would open two reset screens and show "link expired" error. Root causes: (1) `detectSessionInUrl: true` doesn't work in React Native (no URL bar), so tokens weren't being processed, (2) DeepLinkHandler was manually navigating while Expo Router also auto-navigates based on URL path. Fixes: Set `detectSessionInUrl: false` and manually call `supabase.auth.setSession()` with tokens extracted from deep link URL; removed manual navigation since Expo Router handles it; reset screen now polls for session with retries to handle timing.

## January 19, 2026

### Fixed
- **Misleading quota message for free users**: Fixed bug where free users hitting their quota saw "Monthly limit reached - resets next month" instead of "Scan limit reached - Upgrade to Pro". The monthly reset message was misleading because free users have a lifetime limit that never resets. Now checks lifetime limit first before monthly limit.
- **CRITICAL: Quota not consumed on cache hits**: Fixed bug where cached scan results bypassed quota consumption entirely, allowing unlimited free scans. Now properly consumes quota via RPC even when returning cached analysis results.
- **Scan flow instability**: Analysis state now properly resets when scanning a new item (was showing stale results from previous scans when screen was reused)
- **Wardrobe updates not reflected**: Results screen now refreshes wardrobe data when returning from add-item (matches now update immediately after adding wardrobe items)
- **Scan camera processing overlay issues**: Fixed "Checking scan access..." overlay appearing incorrectly when returning to scan screen from results, and eliminated flash of previous camera screen when tapping "Scan another item"

### Security
- Moved OpenAI API key to server-side Edge Function (no longer exposed in client bundle)
- Added server-side rate limiting to prevent abuse (50 requests/user/hour, 100 requests/minute globally)

### Added
- **Monthly quota limits** for all users (including Pro) to prevent runaway API costs
  - Free: 5 scans/month, 15 wardrobe adds/month
  - Pro: 500 scans/month, 1000 wardrobe adds/month
- Server-side quota enforcement via Supabase Edge Function
- Idempotency keys to prevent double-charging on retries
- Auto-retry when app returns from background during analysis
- Credit consumption details added to Help Center (explains when credits are used)

### Fixed
- **Storage upload RLS errors**: Added session verification before background uploads to prevent "row-level security policy" errors when session expires or app restarts before auth is restored
- Wardrobe adds now consume from correct quota pool (was incorrectly using scan credits)
- Dark overlay on logout/transition screens now covers full screen edge-to-edge
- Analysis failures when app goes to background now auto-retry on return
- **Add wardrobe item background recovery**: Fixed bug where adding a wardrobe item while app goes to background would fail to manual form instead of auto-retrying. Now stays in loading state (up to 2 retries) for seamless recovery when returning from background.
- **Scan item background flash eliminated**: Fixed brief flash of "Couldn't analyze" error screen when returning from background during scan analysis. Now stays in loading state for seamless retry (up to 3 attempts).
- **Wardrobe images not refreshing after background upload**: Fixed placeholder images appearing on wardrobe cards after returning from background. React Query now properly integrates with AppState to refetch data when app returns from background, ensuring uploaded images are immediately visible.
- **Wardrobe card loading states**: Added loading spinner to wardrobe item cards when images are loading (e.g., during URI transition from file:// to https:// after upload). Prevents white placeholder flash and provides better visual feedback.
- **Saved scans loading states**: Added loading spinner to saved scan images (ImageWithFallback and ThumbnailWithFallback components) during URI transitions and network loads. Consistent loading experience across all image types.
- Paywall no longer interrupts users who used their last credit successfully (was showing paywall after analysis completed)
- **Scan flow now shows paywall BEFORE capture** when quota exceeded (previously let users scan then blocked them after)
- Scan paywall now shows correct title "You've used your 5 free scans" (was showing wrong paywall type)

### Improved
- **Add wardrobe item performance**: Removed redundant client-side quota check (~100-200ms faster)
- Skip cache lookup for wardrobe adds (user photos are unlikely to be cached, saves ~189ms on misses)
- Image picker no longer forces cropping (iOS limitation prevented free-form crop, now uses full image)
- AI now generates richer style notes (2 descriptive sentences instead of short phrases)

### Technical
- New Edge Function: `analyze-image` handles auth, quota, rate limits, and OpenAI calls
- Database migration: `006_monthly_quotas.sql` adds monthly tracking columns and functions
- `analyzeClothingImage` now accepts `operationType` ('scan' | 'wardrobe_add') and `skipCache` params
- Changes made by agent 2026-01-19T21:07:32Z
- Changes made by agent 2026-01-19T21:12:53Z
- Changes made by agent 2026-01-20T06:34:14Z
- Changes made by agent 2026-01-20T06:35:38Z
- Changes made by agent 2026-01-20T06:37:06Z
- Changes made by agent 2026-01-20T07:20:13Z
- Changes made by agent 2026-01-20T07:25:26Z
- Changes made by agent 2026-01-20T07:26:24Z
- Changes made by agent 2026-01-20T07:28:07Z
- Changes made by agent 2026-01-20T07:30:37Z
- Changes made by agent 2026-01-20T07:34:01Z
